#!/usr/bin/env bash
set -e -u -o pipefail

MAX_DEPTH=14

UZ='../src/uz.rs'
UZ32='../src/uz32.rs'
UZZ='../src/uzz.rs'

cd $(dirname $0)
./preamble <$UZ32 >$UZZ
echo -e '// This file was automatically generated by gen/uzz\n' >>$UZZ
./uses <$UZ >>$UZZ

TEST=$(mktemp)
./tests <$UZ32 >>$TEST

SEED=$(mktemp)
echo >>$SEED
./augment <$TEST | tee -a $UZZ >>$SEED
echo >>$SEED
./impl <$UZ >>$SEED

for N in $(seq 2 $MAX_DEPTH) ; do
    ./augment <$SEED | tee -a $UZZ >$TEST
    cat $TEST >$SEED
done

rm -f $TEST $SEED

